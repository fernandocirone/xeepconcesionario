@model UserPermissionViewModel

<form method="post" asp-page-handler="EditPermissions">
    <input type="hidden" asp-for="UserId" />

    <div class="mb-2">
        <strong>Usuario:</strong> @Model.Email
    </div>

    <!-- Tabs de módulos -->
    <ul class="nav nav-tabs" id="permisoTabs" role="tablist">
        @for (int g = 0; g < Model.Grupos.Count; g++)
        {
            <li class="nav-item" role="presentation">
                <button class="nav-link @(g==0?"active":"")"
                        id="tab-@g"
                        data-bs-toggle="tab"
                        data-bs-target="#content-@g"
                        type="button"
                        role="tab">
                    @Model.Grupos[g].Nombre
                </button>
            </li>
        }
    </ul>

    <!-- Contenido de cada tab -->
    <div class="tab-content mt-3">
        @for (int g = 0; g < Model.Grupos.Count; g++)
        {
            <div class="tab-pane fade @(g==0?"show active":"")"
                 id="content-@g"
                 role="tabpanel">

                <!-- Botón seleccionar todos -->
                <div class="form-check mb-3">
                    <input type="checkbox" class="form-check-input select-all" data-group="@g" id="selectAll-@g" />
                    <label for="selectAll-@g" class="form-check-label fw-bold">Seleccionar todos</label>
                </div>

                <!-- Lista horizontal de permisos -->
                <div class="d-flex flex-wrap gap-3">
                    @for (int i = 0; i < Model.Grupos[g].Permisos.Count; i++)
                    {
                        <div class="form-check form-check-inline">
                            <input type="hidden" name="Grupos[@g].Permisos[@i].Nombre"
                                   value="@Model.Grupos[g].Permisos[i].Nombre" />
                            <input class="form-check-input permiso-checkbox"
                                   type="checkbox"
                                   name="Grupos[@g].Permisos[@i].Asignado"
                                   value="true"
                                   data-group="@g"
                            @(Model.Grupos[g].Permisos[i].Asignado ? "checked" : "") />
                            <label class="form-check-label">
                                @Model.Grupos[g].Permisos[i].Nombre
                            </label>
                        </div>
                    }
                </div>
            </div>
        }
    </div>

    <div class="text-end mt-3">
        <button type="submit" class="btn btn-success">Guardar</button>
    </div>
</form>


<script>
    // Seleccionar todos por grupo
    document.addEventListener("change", function (e) {
        if (e.target.classList.contains("select-all")) {
            const group = e.target.dataset.group;
            const checked = e.target.checked;
            document.querySelectorAll(`.permiso-checkbox[data-group='${group}']`)
                .forEach(cb => cb.checked = checked);
        }

        if (e.target.classList.contains("permiso-checkbox")) {
            const group = e.target.dataset.group;
            const all = document.querySelectorAll(`.permiso-checkbox[data-group='${group}']`);
            const allChecked = Array.from(all).every(cb => cb.checked);
            document.getElementById(`selectAll-${group}`).checked = allChecked;
        }
    });
</script>

