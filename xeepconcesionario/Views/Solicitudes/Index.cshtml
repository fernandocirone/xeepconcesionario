@using Microsoft.AspNetCore.Identity
@inject SignInManager<ApplicationUser> SignInManager

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - LAB Automotores</title>
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/xeepconcesionario.styles.css" asp-append-version="true" />
    <link rel="icon" type="image/jpg" href="~/images/logoxeep.jpg" />

    <style>
        :root {
            --sidebar-w: 220px;
            --sidebar-w-collapsed: 64px;
            --brand-h: 56px;
        }

        body {
            min-height: 100vh;
            display: flex;
            margin: 0;
            overflow-x: hidden;
        }
        /* ===== Sidebar ===== */
        .sidebar {
            position: sticky;
            top: 0;
            height: 100vh;
            width: var(--sidebar-w);
            background: linear-gradient(180deg,#008085,#0069d9);
            color: #fff;
            flex-shrink: 0;
            display: flex;
            flex-direction: column
        }

        .sidebar__brand {
            height: var(--brand-h);
            display: flex;
            align-items: center;
            gap: .5rem;
            padding: 0 1rem;
            font-weight: 700;
            color: #fff;
            text-decoration: none;
            border-bottom: 1px solid rgba(255,255,255,.15)
        }

        .sidebar__toggle {
            margin-left: auto;
            border: 0;
            background: transparent;
            color: #fff;
            font-size: 1.25rem;
            line-height: 1
        }

        .sidebar .nav {
            padding: .5rem 0
        }

        .sidebar .nav-link {
            color: #e0e0e0;
            padding: .6rem .95rem;
            display: flex;
            align-items: center;
            gap: .6rem;
            white-space: nowrap
        }

            .sidebar .nav-link:hover, .sidebar .nav-link.active {
                background: rgba(255,255,255,.10);
                color: #fff
            }

        .nav-ico {
            width: 1.5rem;
            display: inline-flex;
            justify-content: center
        }

        .nav-text {
            overflow: hidden;
            text-overflow: ellipsis
        }

        /* ===== Footer usuario ===== */
        .sidebar__footer {
            margin-top: auto;
            padding: .75rem;
            border-top: 1px solid rgba(255,255,255,.15);
            color: #fff
        }

        .sidebar__user {
            display: flex;
            align-items: center;
            gap: .6rem
        }

        .sidebar__avatar {
            width: 32px;
            height: 32px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,.18);
            border-radius: 50%;
            font-weight: 700
        }

        .sidebar__user-info {
            min-width: 0;
            flex: 1
        }

        .sidebar__user-name {
            font-weight: 600;
            font-size: .95rem;
            line-height: 1.2;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis
        }

        .sidebar__footer .btn-salir, .sidebar__footer .btn-login, .sidebar__footer .btn-reg {
            width: 100%;
            padding: .35rem .5rem;
            font-size: .875rem;
            border-radius: .5rem;
            background: transparent;
            color: #fff;
            border: 1px solid rgba(255,255,255,.35);
            margin-top: .4rem
        }

            .sidebar__footer .btn-salir:hover, .sidebar__footer .btn-login:hover, .sidebar__footer .btn-reg:hover {
                background: rgba(255,255,255,.12);
                color: #fff
            }

        /* ===== Content ===== */
        .content {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0
        }

        .content__inner {
            padding: 1rem
        }

        footer {
            background: #004085;
            color: #ddd;
            padding: 1rem 0;
            text-align: center
        }

        /* ===== Collapsed (desktop) ===== */
        body.sidebar-collapsed .sidebar {
            width: var(--sidebar-w-collapsed)
        }

        body.sidebar-collapsed .nav-text,
        body.sidebar-collapsed .sidebar__brand .brand-text,
        body.sidebar-collapsed .sidebar__user-info {
            display: none
        }

        body.sidebar-collapsed .sidebar__brand {
            justify-content: center
        }

        body.sidebar-collapsed .sidebar__toggle {
            margin: 0
        }

        body.sidebar-collapsed .sidebar__user {
            justify-content: center
        }

        /* ===== Responsive (mobile <992px): offcanvas ===== */
        @@media (max-width: 991.98px) {
            .sidebar {
                position: fixed;
                left: 0;
                top: 0;
                transform: translateX(-100%);
                transition: transform .2s ease;
                z-index: 1040
            }

            body.sidebar-open .sidebar {
                transform: translateX(0)
            }

            .sidebar-backdrop {
                position: fixed;
                inset: 0;
                background: rgba(0,0,0,.35);
                z-index: 1030;
                display: none
            }

            body.sidebar-open .sidebar-backdrop {
                display: block
            }
            /* en móvil no aplicamos estado colapsado mini */
            body.sidebar-collapsed .sidebar {
                width: var(--sidebar-w)
            }
        }

        .topbar {
            height: var(--brand-h);
            display: none;
            align-items: center;
            gap: .5rem;
            padding: 0 1rem;
            border-bottom: 1px solid #eee
        }

        @@media (max-width: 991.98px) {
            .topbar {
                display: flex
            }
        }
    </style>
</head>
<body>
    <!-- Backdrop móvil -->
    <div class="sidebar-backdrop" id="sb-backdrop"></div>

    <!-- SIDEBAR -->
    <aside class="sidebar" id="sidebar">
        <a class="sidebar__brand" asp-area="" asp-controller="Home" asp-action="Index">
            <span class="nav-ico">🚗</span>
            <span class="brand-text">Automotores</span>
            <button class="sidebar__toggle" id="btn-toggle" aria-label="Colapsar menú" title="Colapsar menú">☰</button>
        </a>

        <ul class="nav flex-column">
            @if (SignInManager.IsSignedIn(User))
            {
                <li class="nav-item">
                    <a class="nav-link @(ViewContext.RouteData.Values["Controller"]?.ToString()=="Solicitudes" ? "active" : "")"
                       asp-controller="Solicitudes" asp-action="Index">
                        <span class="nav-ico">📄</span><span class="nav-text">Solicitudes</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link @(ViewContext.RouteData.Values["Controller"]?.ToString()=="Clientes" ? "active" : "")"
                       asp-controller="Clientes" asp-action="Index">
                        <span class="nav-ico">👥</span><span class="nav-text">Clientes</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link @(ViewContext.RouteData.Values["Controller"]?.ToString()=="Planes" ? "active" : "")"
                       asp-controller="Planes" asp-action="Index">
                        <span class="nav-ico">🚘</span><span class="nav-text">Planes</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link @(ViewContext.RouteData.Values["Controller"]?.ToString()=="Cobros" ? "active" : "")"
                       asp-controller="Cobros" asp-action="Index">
                        <span class="nav-ico">💵</span><span class="nav-text">Cobros</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" asp-area="Identity" asp-page="/Account/Register">
                        <span class="nav-ico">👤</span><span class="nav-text">Usuarios</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link @(ViewContext.RouteData.Values["Controller"]?.ToString()=="Configuraciones" ? "active" : "")"
                       asp-controller="Configuraciones" asp-action="Index">
                        <span class="nav-ico">⚙️</span><span class="nav-text">Configuraciones</span>
                    </a>
                </li>
            }
        </ul>

        <!-- ===== Footer usuario (Opción B) ===== -->
        <div class="sidebar__footer">
            @if (SignInManager.IsSignedIn(User))
            {
                <div class="sidebar__user" title="@User?.Identity?.Name">
                    <span class="sidebar__avatar">
                        @((User?.Identity?.Name ?? "U")!.Substring(0, 1).ToUpper())
                    </span>
                    <div class="sidebar__user-info">
                        <div class="sidebar__user-name">@User?.Identity?.Name</div>
                        <form method="post"
                              asp-area="Identity"
                              asp-page="/Account/Logout"
                              asp-route-returnUrl="@Url.Action("Index","Home", new { area = "" })">
                            <button type="submit" class="btn btn-salir">Salir</button>
                        </form>
                    </div>
                </div>
            }
            else
            {
                <a class="btn btn-login" asp-area="Identity" asp-page="/Account/Login">Iniciar sesión</a>
                <a class="btn btn-reg" asp-area="Identity" asp-page="/Account/Register">Registrarse</a>
            }
        </div>
    </aside>

    <!-- CONTENIDO -->
    <div class="content">
        <!-- Topbar solo móvil -->
        <div class="topbar">
            <button class="btn btn-outline-secondary btn-sm" id="btn-open" aria-label="Abrir menú">☰</button>
            <strong class="ms-2">@ViewData["Title"]</strong>
        </div>

        <main class="content__inner" role="main">
            @RenderBody()
        </main>
        <footer>
            <p>© 2025 - LAB Automotores</p>
        </footer>
    </div>

    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="~/js/site.js" asp-append-version="true"></script>
    @await RenderSectionAsync("Scripts", required: false)

    <script>
        (function () {
            const body = document.body;
            const btnToggle = document.getElementById('btn-toggle');
            const btnOpen = document.getElementById('btn-open');
            const backdrop = document.getElementById('sb-backdrop');

            // restaurar preferencia (solo desktop)
            const saved = localStorage.getItem('sidebar-collapsed');
            if (saved === '1' && window.matchMedia('(min-width: 992px)').matches) {
                body.classList.add('sidebar-collapsed');
            }

            btnToggle?.addEventListener('click', function () {
                if (window.matchMedia('(max-width: 991.98px)').matches) {
                    body.classList.toggle('sidebar-open');
                } else {
                    body.classList.toggle('sidebar-collapsed');
                    localStorage.setItem('sidebar-collapsed',
                        body.classList.contains('sidebar-collapsed') ? '1' : '0');
                }
            });

            btnOpen?.addEventListener('click', function () {
                body.classList.add('sidebar-open');
            });

            backdrop?.addEventListener('click', function () {
                body.classList.remove('sidebar-open');
            });

            window.addEventListener('resize', function () {
                if (window.matchMedia('(min-width: 992px)').matches) {
                    body.classList.remove('sidebar-open');
                }
            });
        })();
    </script>
</body>
</html>
