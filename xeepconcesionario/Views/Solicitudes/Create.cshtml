@model CreateSolicitudViewModel
@using System.Security.Claims
@{
    ViewData["Title"] = "Nueva Solicitud";
}
<form asp-action="Create" method="post" id="formSolicitud">
    @Html.AntiForgeryToken()
    <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

    <div class="row g-3">

        <input type="hidden" asp-for="ClienteId" id="ClienteIdHidden" />

        <!-- Número Solicitud -->
        <div class="col-md-6">
            <label asp-for="NumeroSolicitud" class="form-label">Número Solicitud</label>
            <input asp-for="NumeroSolicitud" class="form-control" id="NumeroSolicitud" />
            <span asp-validation-for="NumeroSolicitud" class="text-danger"></span>
        </div>

        <!-- Vendedor -->
        <div class="col-md-6">
            <label asp-for="VendedorUserId" class="form-label">Vendedor</label>
            @{
                var vendedorBloqueado = (bool)(ViewBag.VendedorBloqueado ?? false);
            }
            @if (vendedorBloqueado)
            {
                <select asp-for="VendedorUserId" class="form-select" asp-items="ViewBag.VendedorUserId" disabled></select>
                <input type="hidden" asp-for="VendedorUserId" />
            }
            else
            {
                <select asp-for="VendedorUserId" class="form-select" asp-items="ViewBag.VendedorUserId"></select>
            }
            <span asp-validation-for="VendedorUserId" class="text-danger"></span>
        </div>

        <!-- Supervisor -->
        <div class="col-md-6">
            <label asp-for="SupervisorUserId" class="form-label">Supervisor</label>
            <select asp-for="SupervisorUserId" class="form-select" asp-items="ViewBag.SupervisorUserId"></select>
            <span asp-validation-for="SupervisorUserId" class="text-danger"></span>
        </div>

        <!-- Jefe de Ventas -->
        <div class="col-md-6">
            <label asp-for="JefeVentasUserId" class="form-label">Jefe de Ventas</label>
            <select asp-for="JefeVentasUserId" class="form-select" asp-items="ViewBag.JefeVentasUserId"></select>
            <span asp-validation-for="JefeVentasUserId" class="text-danger"></span>
        </div>

        <!-- Usuario (quien carga) -->
        <input type="hidden" asp-for="UsuarioId" value="@User.FindFirstValue(ClaimTypes.NameIdentifier)" />
    </div>

    <!-- Datos Cliente -->
    <div class="mt-4 p-3 border rounded bg-light">
        <h5 class="fw-bold">DATOS CLIENTE</h5>

        <div class="row g-3 mt-1" id="secCliNuevo">
            <div class="col-md-6">
                <label asp-for="ClienteNuevo.Dni" class="form-label">DNI</label>
                <input asp-for="ClienteNuevo.Dni" class="form-control" />
            </div>
            <div class="col-md-6">
                <label asp-for="ClienteNuevo.ApellidoYNombre" class="form-label">Apellido y Nombre</label>
                <input asp-for="ClienteNuevo.ApellidoYNombre" class="form-control" />
            </div>
            <div class="col-md-6">
                <label asp-for="ClienteNuevo.TelefonoFijo" class="form-label"></label>
                <input asp-for="ClienteNuevo.TelefonoFijo" class="form-control" />
            </div>
            <div class="col-md-6">
                <label asp-for="ClienteNuevo.TelefonoCelular" class="form-label"></label>
                <input asp-for="ClienteNuevo.TelefonoCelular" class="form-control" />
            </div>
            <div class="col-md-6">
                <label asp-for="ClienteNuevo.Mail" class="form-label"></label>
                <input asp-for="ClienteNuevo.Mail" class="form-control" />
            </div>
            <div class="col-md-6">
                <label asp-for="ClienteNuevo.FechaNacimiento" class="form-label"></label>
                <input asp-for="ClienteNuevo.FechaNacimiento" type="date" class="form-control" />
            </div>
            <div class="col-md-12">
                <label asp-for="ClienteNuevo.Direccion" class="form-label"></label>
                <input asp-for="ClienteNuevo.Direccion" class="form-control" />
            </div>
            <div class="col-md-6">
                <label asp-for="ClienteNuevo.Nacionalidad" class="form-label"></label>
                <input asp-for="ClienteNuevo.Nacionalidad" class="form-control" />
            </div>
            <div class="col-md-6">
                <label asp-for="ClienteNuevo.LocalidadId" class="form-label"></label>
                <select asp-for="ClienteNuevo.LocalidadId" class="form-select" asp-items="ViewBag.LocalidadId"></select>
            </div>
            <div class="col-md-6">
                <label asp-for="ClienteNuevo.Barrio" class="form-label"></label>
                <input asp-for="ClienteNuevo.Barrio" class="form-control" />
            </div>
            <div class="col-md-6">
                <label asp-for="ClienteNuevo.TipoVivienda" class="form-label"></label>
                <input asp-for="ClienteNuevo.TipoVivienda" class="form-control" />
            </div>
            <div class="col-md-6">
                <label asp-for="ClienteNuevo.Sexo" class="form-label"></label>
                <input asp-for="ClienteNuevo.Sexo" class="form-control" />
            </div>
            <div class="col-md-6">
                <label asp-for="ClienteNuevo.EstadoCivil" class="form-label"></label>
                <input asp-for="ClienteNuevo.EstadoCivil" class="form-control" />
            </div>
            <div class="col-md-6">
                <label asp-for="ClienteNuevo.Ocupacion" class="form-label"></label>
                <input asp-for="ClienteNuevo.Ocupacion" class="form-control" />
            </div>
            <div class="col-md-6">
                <label asp-for="ClienteNuevo.Empresa" class="form-label"></label>
                <input asp-for="ClienteNuevo.Empresa" class="form-control" />
            </div>
            <div class="col-md-6">
                <label asp-for="ClienteNuevo.DomicilioLaboral" class="form-label"></label>
                <input asp-for="ClienteNuevo.DomicilioLaboral" class="form-control" />
            </div>
            <div class="col-md-6">
                <label asp-for="ClienteNuevo.Cargo" class="form-label"></label>
                <input asp-for="ClienteNuevo.Cargo" class="form-control" />
            </div>
            <div class="col-md-6">
                <label asp-for="ClienteNuevo.IngresosMensuales" class="form-label"></label>
                <input asp-for="ClienteNuevo.IngresosMensuales" class="form-control" />
            </div>
            <div class="col-md-6">
                <label asp-for="ClienteNuevo.TipoOcupacion" class="form-label"></label>
                <input asp-for="ClienteNuevo.TipoOcupacion" class="form-control" />
            </div>
            <div class="col-md-6">
                <label asp-for="ClienteNuevo.RazonSocial" class="form-label"></label>
                <input asp-for="ClienteNuevo.RazonSocial" class="form-control" />
            </div>
            <div class="col-md-6 mt-4">
                <div class="form-check">
                    <input type="checkbox"
                           name="ClienteNuevo.TieneTarjetaCredito"
                           value="true"
                    @(Model.ClienteNuevo.TieneTarjetaCredito == true ? "checked" : "") />
                    <label class="form-check-label">Tiene tarjeta de crédito</label>
                </div>
            </div>
        </div>
    </div>

    <!-- Datos Plan -->
    <div class="mt-4 p-3 border rounded bg-light">
        <h5 class="fw-bold">DATOS PLAN</h5>

        <div class="row g-3 mt-1">
            <div class="col-md-6">
                <label for="codigoAuto" class="form-label">Buscar por código</label>
                <input type="text" id="codigoAuto" class="form-control" placeholder="Ej: C60" />
            </div>
            <div class="col-md-6">
                <label asp-for="PlanId" class="form-label">Plan</label>
                <select asp-for="PlanId" class="form-select" asp-items="ViewBag.PlanId" id="PlanId"></select>
                <span asp-validation-for="PlanId" class="text-danger"></span>
            </div>

            <div class="col-md-6">
                <label class="form-label">Condición de venta</label>
                <select asp-for="CondicionVentaId" class="form-select" asp-items="ViewBag.CondicionVentaId"></select>
            </div>
            <div class="col-md-6">
                <label class="form-label">Tipo de baja</label>
                <select asp-for="TipoBajaId" class="form-select" asp-items="ViewBag.TipoBajaId"></select>
            </div>
            <div class="col-md-6">
                <label class="form-label">Estado</label>
                <select class="form-select" disabled>
                    <option value="1" selected>Nuevo</option>
                </select>
                <input type="hidden" asp-for="EstadoId" value="1" />
            </div>
            <div class="col-md-6">
                <label asp-for="FechaCarga" class="form-label">Fecha de carga</label>
                <input asp-for="FechaCarga" type="date" class="form-control" value="@DateTime.Today.ToString("yyyy-MM-dd")" readonly />
            </div>
            <div class="col-md-6">
                <label asp-for="FechaSuscripcion" class="form-label">Fecha suscripción</label>
                <input asp-for="FechaSuscripcion" type="date" class="form-control" value="@DateTime.Today.ToString("yyyy-MM-dd")" />
            </div>
            <div class="col-md-6">
                <label asp-for="ValorSellado1" class="form-label">Valor Sellado</label>
                <input asp-for="ValorSellado1" class="form-control" id="ValorSellado1" />
            </div>
            <div class="col-md-6">
                <label asp-for="ValorSellado2" class="form-label">Valor Sellado 2</label>
                <input asp-for="ValorSellado2" class="form-control" id="ValorSellado2" />
            </div>

            <div class="col-md-4">
                <label asp-for="CantidadCuotas" class="form-label">Cantidad cuotas</label>
                <input asp-for="CantidadCuotas" class="form-control" />
            </div>
            <div class="col-md-4">
                <label asp-for="FechaPrimerVencimiento" class="form-label">1er vencimiento</label>
                <input asp-for="FechaPrimerVencimiento" type="date" class="form-control" />
            </div>
            <div class="col-md-4">
                <label asp-for="ImporteCuota" class="form-label">Importe cuota</label>
                <input asp-for="ImporteCuota" class="form-control" id="ImporteCuota" />
            </div>
            <div class="col-md-12">
                <label asp-for="ObservacionSolicitud" class="form-label">Observación</label>
                <input asp-for="ObservacionSolicitud" class="form-control" />
            </div>
        </div>
    </div>

    <!-- Botón -->
    <div class="mt-4 d-flex justify-content-end">
        <button type="submit" class="btn btn-primary">
            <i class="bi bi-save"></i> Guardar Solicitud
        </button>
    </div>
</form>



<!-- Modal: Cliente ya existente con solicitudes -->
<div class="modal fade" id="modalClienteExiste" tabindex="-1" aria-labelledby="modalClienteExisteLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-warning-subtle">
                <h5 id="modalClienteExisteLabel" class="modal-title">
                    ⚠️ Cliente existente
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>

            <div class="modal-body">
                <p class="mb-2">
                    El DNI <strong id="dniModalTxt"></strong> corresponde a
                    <strong id="nombreClienteTxt"></strong>.
                </p>
                <p class="mb-3">
                    Este cliente ya tiene <strong id="cantSolicitudesTxt">0</strong> solicitud(es) registrada(s):
                </p>

                <div class="table-responsive">
                    <table class="table table-sm table-striped align-middle" id="tablaSolicitudesCliente">
                        <thead>
                            <tr>
                                <th style="width: 120px;">N° Solicitud</th>
                                <th>Estado</th>
                                <th style="width: 160px;">Fecha</th>
                                <th style="width: 120px;">Acciones</th>
                            </tr>
                        </thead>
                        <tbody><!-- se llena por JS --></tbody>
                    </table>
                </div>

                <div class="alert alert-info mt-3" id="sinSolicitudesMsg" style="display:none;">
                    No se encontraron solicitudes previas para este cliente.
                </div>
            </div>

            <div class="modal-footer">
                <a id="btnVerListaCliente" class="btn btn-outline-secondary" href="#" target="_blank">
                    <i class="bi bi-list-ul"></i> Ver todas las solicitudes del cliente
                </a>
                <button type="button"
                        class="btn btn-primary"
                        data-bs-dismiss="modal">
                    Continuar de todos modos
                </button>

            </div>
        </div>
    </div>
</div>

@section Scripts {
    @await Html.PartialAsync("_ValidationScriptsPartial")

    <script>
        // ====== MODAL CLIENTE EXISTE ======
        const modalClienteEl = document.getElementById('modalClienteExiste');
        const modalCliente = new bootstrap.Modal(modalClienteEl, {
            backdrop: true,
            keyboard: true,
            focus: true
        });

        let lastQueriedDni = "";
        let lastModalDni = "";
        let suppressUntilChange = false;

        // Botón "Continuar de todos modos": solo cerrar modal
        document
            .querySelector('#modalClienteExiste .btn.btn-primary[data-bs-dismiss="modal"]')
            ?.addEventListener('click', () => {
                modalCliente.hide();
            });

        (function () {
            const dniInput = document.getElementById('ClienteNuevo_Dni');
            if (!dniInput) return;

            let debounceTimer = null;

            function normalizarDni(v) {
                return (v || "").trim().replaceAll(".", "").replaceAll("-", "");
            }

            function rellenarCamposCliente(cliente) {
                if (!cliente) return;

                // Guardar ClienteId en hidden
                let inputClienteId = document.getElementById('ClienteIdHidden');
                if (!inputClienteId) {
                    inputClienteId = document.createElement('input');
                    inputClienteId.type = 'hidden';
                    inputClienteId.id = 'ClienteIdHidden';
                    inputClienteId.name = 'ClienteId';
                    document.getElementById('formSolicitud').appendChild(inputClienteId);
                }
                inputClienteId.value = cliente.clienteId;

                // Rellenar campos de cliente
                document.getElementById('ClienteNuevo_ApellidoYNombre').value = cliente.apellidoYNombre ?? "";
                document.getElementById('ClienteNuevo_TelefonoFijo').value = cliente.telefonoFijo ?? "";
                document.getElementById('ClienteNuevo_TelefonoCelular').value = cliente.telefonoCelular ?? "";
                document.getElementById('ClienteNuevo_Mail').value = cliente.mail ?? "";
                document.getElementById('ClienteNuevo_Direccion').value = cliente.direccion ?? "";
                document.getElementById('ClienteNuevo_Nacionalidad').value = cliente.nacionalidad ?? "";
                document.getElementById('ClienteNuevo_Barrio').value = cliente.barrio ?? "";
                document.getElementById('ClienteNuevo_TipoVivienda').value = cliente.tipoVivienda ?? "";
                document.getElementById('ClienteNuevo_Sexo').value = cliente.sexo ?? "";
                document.getElementById('ClienteNuevo_EstadoCivil').value = cliente.estadoCivil ?? "";
                document.getElementById('ClienteNuevo_Ocupacion').value = cliente.ocupacion ?? "";
                document.getElementById('ClienteNuevo_Empresa').value = cliente.empresa ?? "";
                document.getElementById('ClienteNuevo_DomicilioLaboral').value = cliente.domicilioLaboral ?? "";
                document.getElementById('ClienteNuevo_Cargo').value = cliente.cargo ?? "";
                document.getElementById('ClienteNuevo_IngresosMensuales').value = cliente.ingresosMensuales ?? "";
                document.getElementById('ClienteNuevo_TipoOcupacion').value = cliente.tipoOcupacion ?? "";
                document.getElementById('ClienteNuevo_RazonSocial').value = cliente.razonSocial ?? "";

                // Fecha nacimiento (si viene con valor)
                if (cliente.fechaNacimiento) {
                    const fecha = new Date(cliente.fechaNacimiento);
                    document.getElementById('ClienteNuevo_FechaNacimiento').value = fecha.toISOString().split("T")[0];
                }

                // Localidad
                if (cliente.localidadId) {
                    document.getElementById('ClienteNuevo_LocalidadId').value = cliente.localidadId;
                }

                // TieneTarjetaCredito
                const chk = document.querySelector("input[name='ClienteNuevo.TieneTarjetaCredito']");
                if (chk) chk.checked = cliente.tieneTarjetaCredito === true;
            }

            function buscarClientePorDni(dniRaw) {
                const dni = normalizarDni(dniRaw);
                if (!dni) return;

                if (suppressUntilChange) return;
                if (dni === lastQueriedDni) return;

                lastQueriedDni = dni;

                fetch('@Url.Action("CheckClientePorDni", "Solicitudes")' + '?dni=' + encodeURIComponent(dni))
                    .then(r => r.ok ? r.json() : Promise.reject(r))
                    .then(data => {
                        if (!data || !data.exists) return;
                        if (dni === lastModalDni) return;

                        // Rellenar modal
                        document.getElementById('dniModalTxt').textContent = dni;
                        document.getElementById('nombreClienteTxt').textContent = data.nombre ?? '(sin nombre)';
                        document.getElementById('cantSolicitudesTxt').textContent = data.solicitudesCount ?? 0;

                        const tbody = document.querySelector('#tablaSolicitudesCliente tbody');
                        tbody.innerHTML = '';

                        const arr = Array.isArray(data.solicitudes) ? data.solicitudes : [];
                        if (arr.length === 0) {
                            document.getElementById('sinSolicitudesMsg').style.display = '';
                        } else {
                            document.getElementById('sinSolicitudesMsg').style.display = 'none';
                            for (const s of arr) {
                                const tr = document.createElement('tr');

                                const tdNum = document.createElement('td');
                                tdNum.textContent = s.numeroSolicitud ?? s.solicitudId ?? '—';
                                tr.appendChild(tdNum);

                                const tdEstado = document.createElement('td');
                                tdEstado.textContent = s.estado ?? '—';
                                tr.appendChild(tdEstado);

                                const tdFecha = document.createElement('td');
                                const fecha = s.fecha ? new Date(s.fecha) : null;
                                tdFecha.textContent = fecha ? fecha.toLocaleDateString() : '—';
                                tr.appendChild(tdFecha);

                                const tdAcc = document.createElement('td');
                                const a = document.createElement('a');
                                a.className = 'btn btn-sm btn-outline-primary';
                                a.innerHTML = '<i class="bi bi-eye"></i> Ver';
                                a.href = '/Solicitudes/Details/' + (s.solicitudId ?? s.SolicitudId);
                                a.target = '_blank';
                                tdAcc.appendChild(a);
                                tr.appendChild(tdAcc);

                                tbody.appendChild(tr);
                            }
                        }

                        // 👉 Rellenar formulario con los datos del cliente
                        rellenarCamposCliente(data.cliente);

                        // 👉 Botón "Ver todas"
                        const btnLista = document.getElementById('btnVerListaCliente');
                        if (btnLista) btnLista.href = '/Solicitudes?clienteId=' + encodeURIComponent(data.clienteId);

                        // Mostrar modal
                        lastModalDni = dni;
                        suppressUntilChange = true;
                        modalCliente.show();
                    })
                    .catch(err => console.error('Error CheckClientePorDni:', err));
            }

            dniInput.addEventListener('input', () => {
                clearTimeout(debounceTimer);

                const valNorm = normalizarDni(dniInput.value);
                if (valNorm !== lastModalDni) {
                    suppressUntilChange = false;
                }

                debounceTimer = setTimeout(() => buscarClientePorDni(dniInput.value), 600);
            });
        })();
    </script>


    <script>
        // Buscar auto por prefijo de código
        document.getElementById('codigoAuto').addEventListener('input', function () {
            const codigo = this.value.toLowerCase();
            const $sel = $('#PlanId');
            for (const opt of $sel[0].options) {
                if (opt.text.toLowerCase().startsWith(codigo)) {
                    $sel.val(opt.value).trigger('change');
                    break;
                }
            }
        });

        // --- Precarga de sellados por Plan ---
        (function () {
            const urlBase = '/Planes/sellados/';

            $(document).on('change', '#PlanId', function () {
                const id = $(this).val();
                if (!id) { limpiarSellados(); return; }
                cargarSellados(id);
            });

            $(function () {
                const id = $('#PlanId').val();
                if (id) cargarSellados(id);
            });

            $(document).on('shown.bs.modal', '#modalCrearSolicitud', function () {
                const id = $('#PlanId').val();
                if (id) cargarSellados(id);
            });

            function cargarSellados(PlanId) {
                $.getJSON(urlBase + PlanId)
                    .done(function (data) {
                        setSellados(data?.sellado1, data?.sellado2, data?.importeCuota);
                    })
                    .fail(function (xhr) {
                        console.error('Error al obtener sellados', xhr.status, xhr.responseText);
                        limpiarSellados();
                    });
            }

            function setSellados(s1, s2, importe) {
                $('#ValorSellado1').val(s1 ?? 0);
                $('#ValorSellado2').val(s2 ?? 0);
                $('#ImporteCuota').val(importe ?? 0);
            }

            function limpiarSellados() {
                $('#ValorSellado1').val('');
                $('#ValorSellado2').val('');
                $('#ImporteCuota').val('');
            }
        })();
    </script>
}

