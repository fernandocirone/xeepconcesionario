@model Solicitud
@using System.Security.Claims

@{
    ViewData["Title"] = "Editar Solicitud";
}

<style>
    #ContratoId {
        pointer-events: none; /* simula readonly */
        background-color: #e9ecef; /* gris de inputs deshabilitados */
    }
</style>

<h2 class="mb-3">Editar Solicitud</h2>

<form asp-action="Edit" method="post" novalidate>
    @Html.AntiForgeryToken()
    <div asp-validation-summary="ModelOnly" class="text-danger"></div>
    <input type="hidden" asp-for="SolicitudId" />

    <div class="row g-3">

        <!-- Contrato -->
        <div class="col-md-6">
            <label class="form-label">Negociación</label>
            <div class="input-group">
                <select asp-for="ContratoId"
                        class="form-select form-select-sm"
                        asp-items="ViewBag.ContratoId"
                        id="ContratoId"
                        style="max-width: 200px;">
                </select>
                <button type="button"
                        class="btn btn-outline-primary btn-sm"
                        id="abrirModalContrato"
                        data-bs-toggle="modal"
                        data-bs-target="#modalContrato">
                    <i class="bi bi-plus-circle"></i> Nuevo
                </button>
            </div>
            <span asp-validation-for="ContratoId" class="text-danger"></span>
        </div>

        <!-- Numero Solicitud -->
        <div class="col-md-6">
            <label asp-for="NumeroSolicitud" class="form-label">Numero Solicitud</label>
            <input asp-for="NumeroSolicitud" class="form-control" id="NumeroSolicitud" />
            <span asp-validation-for="NumeroSolicitud" class="text-danger"></span>
        </div>


        <!-- Vendedor -->
        <div class="col-md-6">
            <label asp-for="VendedorUserId" class="form-label">Vendedor</label>
            <select asp-for="VendedorUserId" class="form-select" asp-items="ViewBag.VendedorUserId"></select>
            <span asp-validation-for="VendedorUserId" class="text-danger"></span>
        </div>


        <!-- Supervisor -->
        <div class="col-md-6">
            <label asp-for="SupervisorUserId" class="form-label">Supervisor</label>
            <select asp-for="SupervisorUserId" class="form-select" asp-items="ViewBag.SupervisorUserId"></select>
            <span asp-validation-for="SupervisorUserId" class="text-danger"></span>
        </div>

        <!-- Jefe de Ventas -->
        <div class="col-md-6">
            <label asp-for="JefeVentasUserId" class="form-label">Jefe de Ventas</label>
            <select asp-for="JefeVentasUserId" class="form-select" asp-items="ViewBag.JefeVentasUserId"></select>
            <span asp-validation-for="JefeVentasUserId" class="text-danger"></span>
        </div>

        <!-- Usuario -->
        <div class="col-md-6">
            <label class="form-label">Usuario</label>
            <input type="text" class="form-control" value="@User.Identity?.Name" readonly />
            <input type="hidden" asp-for="UsuarioId" value="@Model.UsuarioId" />
            <span asp-validation-for="UsuarioId" class="text-danger"></span>
        </div>

        <!-- Cliente -->
        <div class="col-md-6">
            <label asp-for="ClienteId" class="form-label">Cliente</label>
            <select asp-for="ClienteId" class="form-select" asp-items="ViewBag.ClienteId"></select>
            <span asp-validation-for="ClienteId" class="text-danger"></span>
        </div>

        <!-- Buscar por código -->
        <div class="col-md-6">
            <label for="codigoAuto" class="form-label">Buscar por código</label>
            <input type="text" id="codigoAuto" class="form-control" placeholder="Ej: C60" />
        </div>

        <!-- Automóvil -->
        <div class="col-md-6">
            <label asp-for="PlanId" class="form-label">Automóvil</label>
            <select asp-for="PlanId" class="form-select" asp-items="ViewBag.PlanId" id="PlanId"></select>
            <span asp-validation-for="PlanId" class="text-danger"></span>
        </div>

        <!-- Condición Venta -->
        <div class="col-md-6">
            <label class="form-label">Condición de Venta</label>
            <select asp-for="CondicionVentaId" class="form-select" asp-items="ViewBag.CondicionVentaId"></select>
            <span asp-validation-for="CondicionVentaId" class="text-danger"></span>
        </div>

        <!-- Tipo Baja -->
        <div class="col-md-6">
            <label class="form-label">Tipo de Baja</label>
            <select asp-for="TipoBajaId" class="form-select" asp-items="ViewBag.TipoBajaId"></select>
            <span asp-validation-for="TipoBajaId" class="text-danger"></span>
        </div>

        <!-- Estado -->
        <div class="col-md-6">
            <label class="form-label">Estado</label>
            <select asp-for="EstadoId" class="form-select" asp-items="ViewBag.EstadoId"></select>
            <span asp-validation-for="EstadoId" class="text-danger"></span>
        </div>

        <!-- Fechas -->
        <div class="col-md-6">
            <label asp-for="FechaCarga" class="form-label">Fecha de carga</label>
            <input asp-for="FechaCarga" type="date" class="form-control"
                   value="@(Model.FechaCarga?.ToString("yyyy-MM-dd"))" readonly />
        </div>

        <div class="col-md-6">
            <label asp-for="FechaSuscripcion" class="form-label">Fecha de suscripción</label>
            <input asp-for="FechaSuscripcion" type="date" class="form-control"
                   value="@(Model.FechaSuscripcion?.ToString("yyyy-MM-dd"))" />
        </div>

        <!-- Sellados -->
        <div class="col-md-6">
            <label asp-for="ValorSellado1" class="form-label">Valor Sellado</label>
            <input asp-for="ValorSellado1" class="form-control" id="ValorSellado1" inputmode="decimal" />
        </div>

        <div class="col-md-6">
            <label asp-for="ValorSellado2" class="form-label">Valor Sellado 2</label>
            <input asp-for="ValorSellado2" class="form-control" id="ValorSellado2" inputmode="decimal" />
        </div>

        <!-- Observación -->
        <div class="col-md-12">
            <label asp-for="ObservacionSolicitud" class="form-label">Observación</label>
            <input asp-for="ObservacionSolicitud" class="form-control" />
        </div>
    </div>

    <div class="mt-4 d-flex justify-content-end">
        <button type="submit" class="btn btn-primary">
            <i class="bi bi-save"></i> Guardar Cambios
        </button>
    </div>
</form>

<!-- Modal Contrato igual que en Create -->
<div class="modal fade" id="modalContrato" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Nuevo Contrato</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <form id="formContrato" autocomplete="off">
                    <div class="mb-3">
                        <label for="NombreContrato" class="form-label">Nombre</label>
                        <input id="NombreContrato" name="NombreContrato" class="form-control" />
                    </div>
                    <div class="mb-3">
                        <label for="DescripcionContrato" class="form-label">Descripción</label>
                        <textarea id="DescripcionContrato" name="DescripcionContrato" class="form-control"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="PlazoMeses" class="form-label">Plazo (meses)</label>
                        <input id="PlazoMeses" name="PlazoMeses" type="number" min="0" class="form-control" />
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="btnGuardarContrato">Guardar</button>
            </div>
        </div>
    </div>
</div>


@section Scripts {
    @await Html.PartialAsync("_ValidationScriptsPartial")

    <script>
        // --- Si ContratoId viene vacío/0, setear 1 (por si se edita algo viejo con dato faltante)
        $(function () {
            const $sel = $('#ContratoId');
            if (!$sel.val() || $sel.val() === '0') {
                $sel.val('1').trigger('change');
            }
        });

        // --- Abrir "Nuevo Contrato": el data-bs-* ya lo abre; fallback a navegar si no existiera el modal
        $(document).on('click', '#abrirModalContrato', function () {
            const $modalContrato = $('#modalContrato');
            if (!$modalContrato.length) {
                window.location.href = '@Url.Action("Create", "Contratos", new { from = "solicitudes" })';
            }
        });

        // --- Guardar contrato por AJAX y agregar al select
        $(document).on('click', '#btnGuardarContrato', function () {
            if (!$('#formContrato').length) return;

            const datos = {
                NombreContrato: $("#NombreContrato").val(),
                DescripcionContrato: $("#DescripcionContrato").val(),
                PlazoMeses: $("#PlazoMeses").val()
            };

            if (!datos.NombreContrato) { alert("El nombre del contrato es obligatorio."); return; }

            $.post('@Url.Action("CrearDesdeSolicitud", "Contratos")', datos)
                .done(function (resp) {
                    if (resp?.success) {
                        const $sel = $("#ContratoId");
                        let $opt = $sel.find(`option[value='${resp.id}']`);
                        if ($opt.length) {
                            $opt.text(resp.nombre).prop('selected', true);
                        } else {
                            $sel.append(new Option(resp.nombre, resp.id, true, true));
                        }
                        $sel.trigger('change');

                        $("#modalContrato").modal('hide');
                        $("#formContrato")[0].reset();
                    } else {
                        alert("Error: " + (resp?.message ?? "Respuesta inválida"));
                    }
                })
                .fail(function (xhr) {
                    alert("Error al guardar el contrato: " + xhr.statusText);
                });
        });

        // --- Precarga de sellados por automóvil
        (function () {
            const urlBase = '/Planes/sellados/';

            $(document).on('change', '#PlanId', function () {
                const id = $(this).val();
                if (!id) { limpiarSellados(); return; }
                cargarSellados(id);
            });

            // al cargar el Edit, precargar según auto actual
            $(function () {
                const id = $('#PlanId').val();
                if (id) cargarSellados(id);
            });

            function cargarSellados(PlanId) {
                $.getJSON(urlBase + PlanId)
                    .done(function (data) {
                        setSellados(data?.sellado1, data?.sellado2);
                    })
                    .fail(function (xhr) {
                        console.error('Error al obtener sellados', xhr.status, xhr.responseText);
                        limpiarSellados();
                    });
            }

            function setSellados(s1, s2) {
                $('#ValorSellado1').val(s1 ?? 0);
                $('#ValorSellado2').val(s2 ?? 0);
            }

            function limpiarSellados() {
                $('#ValorSellado1').val('');
                $('#ValorSellado2').val('');
            }
        })();

        // --- Búsqueda por código en el select de automóvil
        $(document).on('input', '#codigoAuto', function () {
            const codigo = $(this).val().trim().toLowerCase();
            if (!codigo) return;

            const $opts = $('#PlanId option');
            for (let i = 0; i < $opts.length; i++) {
                const $opt = $($opts[i]);
                const txt = ($opt.text() || '').toLowerCase();
                if (txt.startsWith(codigo)) {
                    $opt.prop('selected', true);
                    $('#PlanId').trigger('change');
                    break;
                }
            }
        });
    </script>
}
